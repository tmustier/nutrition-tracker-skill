# Complete workflow for adding dishes

**CRITICAL: Follow this complete workflow when adding new dishes. Do NOT skip steps.**

1. **Research thoroughly** (use multiple sources):
   - Start with delivery platforms (Deliveroo/Uber Eats) for calorie counts and ingredient lists
   - Search for venue PDFs, allergen menus, nutrition guides
   - Look at photos (venue website, Google Maps, social media) to estimate portions
   - Check reviews for portion size hints ("massive", "small", etc.)
   - Search for chef recipes, prep videos, or ingredient breakdowns
   - **Be creative**: if standard sources fail, use comparable dishes, USDA data, or ingredient analysis
   - **Goal**: Fill in ALL nutrition fields, not just calories and macros

2. **Create dish file and populate data**:
   - Use `scripts/new_dish_from_template.py` to create a new dish file in the appropriate folder:
     ```bash
     python scripts/new_dish_from_template.py \
       --dish_slug dish_name \
       --venue_slug venue_abbreviation \
       --venue_name "Full Venue Name" \
       --display_name "Dish Name (Venue)" \
       --category main
     ```
   - The script auto-detects the venue category and creates the file in the correct location
   - Fill in ALL available fields: macros, micronutrients, MUFA/PUFA breakdown
   - For estimated values, document your reasoning in `assumptions` and `notes`
   - Add comprehensive `source.evidence` with URLs and methods used
   - Update `change_log` with timestamp and what you added

3. **Validate before committing**:
   - Run `python scripts/validate_data_bank.py` (no arguments needed - scans all files)
   - Fix any errors (energy math, fat splits, sodium/salt)
   - Re-run validation until ALL items pass
   - The index (`data/food-data-bank-index.md`) will be auto-generated by the validation script

4. **Document research findings** (if applicable):
   - Add learnings, tips, or venue-specific guidance to the venue's `RESEARCH.md` file
   - Venue-specific files: `data/food-data-bank/venues/{venue-name}/RESEARCH.md`
   - Include useful research methods, data sources, or estimation techniques

5. **Commit with clear message**:
   - Commit changes with descriptive message
   - Include calorie counts and what was added in the commit message

**Do NOT default to generic values. If exact data is unavailable, use ingredient-based estimation and document your method.**

# Quick Reference Data

## Standard Portions

| Item | Weight | Notes |
|------|--------|-------|
| Eggs | 50g each | Standard large egg |
| Bread slice | 60g | 50-70g range; NOT 100g |
| Yogurt | 100-120g | Restaurant serving |
| Cooked vegetables | 50-80g | Side portion |
| Restaurant soup | ~300g | Standard bowl |

## Fatty Acid Profiles

**Common Oils:**
- **Olive oil:** ~73% MUFA, ~11% PUFA, ~14% SFA
- **Coconut:** ~83% SFA, ~6% MUFA, ~2% PUFA
- **Butter:** ~51% SFA, ~21% MUFA, ~3% PUFA

**Common Proteins:**
- **Wagyu beef:** ~40% MUFA, ~20% PUFA of total fat
- **Chicken:** ~45% MUFA, ~21% PUFA of total fat
- **Salmon:** ~29% MUFA, ~40% PUFA of total fat

## Research Source Priority

1. **PRIMARY (highest confidence):** Deliveroo UK, Uber Eats UK, venue nutrition PDFs, product labels
2. **SECONDARY (estimate/scale):** USDA FoodData Central, MyFoodData.com, comparable dishes from similar venues

# Nutrient Estimation Philosophy

## Core Principle

**Never use null. Always estimate with documented confidence.**

- `0` = TRUE ZERO (scientifically impossible, e.g., cholesterol in plants, fiber in animal products, B12 in unfortified plants)
- All other values = actual measurement or estimate

## Estimation Process

1. **Search USDA FoodData Central** for closest match
2. **Scale to portion weight** (USDA values are per 100g)
3. **Document source and confidence** in `assumptions` field if non-obvious
4. **Validate energy**: 4P + 9F + 4C_avail + 2fiber + 2.4polyols

## Confidence Levels

- **HIGH** (±5-15%): USDA direct match, nutrition label
- **MEDIUM** (±20-40%): USDA proxy, component calculation, UK dairy iodine
- **LOW** (±50-100%): category average, soil-dependent nutrients

## UK-Specific Note

**Iodine in dairy**: UK cattle feed is fortified, resulting in 2-3× higher iodine than EU. UK dairy is MEDIUM-HIGH confidence for iodine estimates.

## TRUE ZEROS

No estimation needed when value is scientifically zero:
- Cholesterol: plant foods
- B12: unfortified plant foods
- Fiber: pure animal products
- Iodine: pure oils/fats

# Analysis rules
Always write down what was used. Put links/notes under `source.evidence`.

**For Simple Health Kitchen (SHK):**
- **Check both**: the **Deliveroo** page (names, **ingredient list**, photos) **and** the **SHK Calories PDF**
  (kcal and P/C/F). Names may differ slightly; match the prep, not just the label.
- **Anchor macros** (kcal, protein, carbs, fat) to the SHK source that exactly matches the dish:
  - If the PDF has the **exact same item**, prefer it for macros.
  - If the PDF lists a **different prep** (e.g., *Roasted Sweet Potatoes* vs *Wedges*), prefer Deliveroo macros
    for the dish actually ordered.
- **Use Deliveroo ingredients + photos** to infer: oil type, dressing, toppings, and portion reasonableness.
- **Compute the rest** (sodium, sugars, fibre, vitamins/minerals, MUFA/PUFA/trans) from ingredient profiles
  (e.g., USDA/MyFoodData) **scaled to the anchored macros**.

**For other venues (get creative, but be explicit):**
- Use delivery menus (Deliveroo/Uber Eats/Just Eat), venue PDFs, and **photos** (gallery, socials, Google Maps).
- Read **ingredient lists** and **allergens**; check **reviews** for portion hints (“huge bowl”, “tiny cup”).
- Look for **chef/restaurant recipes** or prep videos that reveal oil type, cooking method, or weights.
- Estimate **portion weight** from photos: plate diameter, container size, standard yields (e.g., pasta ~140–160 g per cup cooked; salmon cooks down ~25% from raw). State the method in `assumptions`.
- If nothing authoritative exists, choose the **closest canonical ingredient profile** and **record the choice**.

**Component-based estimation (REQUIRED for multi-ingredient dishes):**

When a dish has multiple identifiable components (e.g., eggs + yogurt + bread + butter), use this rigorous method:

1. **List all components** from the ingredient list (e.g., "2 poached eggs, garlic yogurt, sourdough, kale, chilli butter")

2. **Estimate weights for known components** using standard portions:
   - Eggs: 50g each (100g for 2 eggs)
   - Yogurt base: 100-120g typical for restaurant
   - Bread slice: 50-70g (NOT 100g - be conservative!)
   - Vegetables: 50-80g cooked portions
   - Leave one component (usually fat/oil/butter) as the "closing variable"

3. **Calculate sub-totals** for known components using USDA/MyFoodData profiles:
   - Example: 2 eggs (140 kcal) + yogurt 120g (72 kcal) + bread 60g (150 kcal) + kale 50g (17 kcal) = 379 kcal

4. **Solve for the unknown component** (usually butter/oil) to close the calorie gap:
   - If venue lists 592 kcal total: 592 - 379 = 213 kcal from butter
   - Butter is ~7.2 kcal/g → 213 ÷ 7.2 = ~30g butter
   - Check reasonableness: 30g (2 tbsp) is plausible for chilli butter

5. **Calculate complete macros** by summing all components with their precise weights:
   - Get USDA profiles for each (protein, fat, carbs, sat fat, MUFA, PUFA, sodium, etc.)
   - Scale each component to its estimated weight
   - Sum all values
   - **Document the calculation method in `notes`**

6. **Apply finishing salt** per salt_scheme (0.5% of total dish weight):
   - Total weight = sum of all components (e.g., 352g)
   - Finishing salt = 352g × 0.005 = 1.76g salt = ~704mg additional sodium
   - Add this to intrinsic sodium from ingredients (bread, salted butter, etc.)

7. **Validate** using the available-carb Atwater formula (`4P + 9F + 4*carbs_available + 2*fibre + 2.4*polyols`): keep results within ±5% of venue kcal or document why.

**Example worked calculation:**
```
Dish: Chilli Poached Eggs (L'ETO, 592 kcal listed)
Components: 2 eggs, garlic yogurt, sourdough, kale, chilli butter

Step 1 - Estimate known components:
- 2 poached eggs: 2×50g = 100g → 140 kcal, 12.6g P, 9.5g F, 0.7g C
- Greek yogurt (whole): 120g → 72 kcal, 9.6g P, 3.8g F, 4.8g C
- Sourdough: 60g slice → 150 kcal, 5.4g P, 0.9g F, 29g C
- Kale (cooked): 50g → 17 kcal, 1.6g P, 0.3g F, 3.3g C
Sub-total: 379 kcal, 29.2g P, 14.5g F, 37.8g C

Step 2 - Solve for butter to close calorie gap:
592 - 379 = 213 kcal needed → ~30g butter
(Refine with actual profiles to 22.2g for exact match)

Step 3 - Apply finishing salt:
Dish weight: 352g → salt 1.76g = 704mg sodium
Add intrinsic sodium from bread + butter
TOTAL SODIUM: ~1,543mg

Step 4 - Validate Atwater:
4×30.4 + 9×34.2 + 4×40.3 + 2×3.4 + 2.4×0.0 = 597.4 kcal (≈592 kcal label; note variance)
```

**Standard assumptions (write them in `assumptions`):**
- `salt_scheme: "normal"` → add ~**0.5% of finished dish weight** as salt (≈ **sodium_mg = salt_g * 400**).
- `oil_type:` venue norm (e.g., olive oil for SHK). Use typical FA split (~73% MUFA / ~11% PUFA / ~14% SFA).
- Portion weight → labeled value if present; otherwise an estimate with a one‑line rationale.

**Consistency checks (before saving):**
- **Energy (Atwater)**: `kcal ≈ 4*protein + 9*fat + 4*carbs_available + 2*fibre + 2.4*polyols` (tolerance ±5–8%). Explain any gap.
- **Fat split**: `sat + MUFA + PUFA + trans ≤ total fat` (difference = unassigned/rounding).
- **Sodium↔salt**: compute `salt_g_from_sodium = sodium_mg * 2.5 / 1000` in `derived`.
- **No negatives**; keep unknowns as `null`.
- Rounding: kcal integer; grams **1 dp**; mg/µg integers.

**Edit protocol (append‑only):**
1. Locate dish by `id` (or add a new block from the Schema TEMPLATE).
2. Edit values → **bump `version`** → update **`last_verified: YYYY-MM-DD`**.
3. Append a `change_log` item: timestamp, reason, `fields_changed`, and **evidence links**.
4. Never rewrite old change log entries.

## CLI helpers (scripts)

### `scripts/validate_data_bank.py`
Validate all dish files in the data bank. Checks:
- Available-carb energy math, fat‑split coherence, sodium↔salt, missing required keys, negative values.
- Scans `data/food-data-bank/` directory recursively
- Emits a human summary and a JSON report (to stdout).
- Auto-regenerates the index after successful validation.

Usage:
```bash
python scripts/validate_data_bank.py
# Or specify custom directory:
python scripts/validate_data_bank.py data/food-data-bank
```

### `scripts/new_dish_from_template.py`
Create a new dish file in the appropriate venue/category folder.

Usage:
```bash
python scripts/new_dish_from_template.py \
  --dish_slug grilled_salmon_fillet \
  --venue_slug shk \
  --venue_name "Simple Health Kitchen, Baker Street (London)" \
  --display_name "Grilled Salmon Fillet (SHK)" \
  --category main \
  --portion_desc "restaurant portion"
```

The script creates a new file in the appropriate folder and auto-regenerates the index file; review and commit the changes.

### `scripts/generate_index.py`
Generate the index from all dish files.

Usage:
```bash
python scripts/generate_index.py
```

This is typically called automatically by the validation script, but can be run manually if needed.

## Style guide (data entry)
- Keep numbers **consistent with evidence** and **state assumptions** in one line.
- Prefer **fewer, better** sources; list them in `source.evidence` (URLs or short notes).
- If Deliveroo vs venue PDF disagree, choose the **exact‑match prep** as the macro anchor and explain.
- Keep language neutral and terse—future‑you will thank current‑you.

## Research notes
For accumulated research findings and venue-specific guidance:
- Venue-specific research notes: `data/food-data-bank/venues/{venue-name}/RESEARCH.md` (where available)
  - Example: Jean-Georges at The Connaught → `data/food-data-bank/venues/jean-georges-connaught/RESEARCH.md`
  - Example: L'ETO Caffe Soho → `data/food-data-bank/venues/leto-caffe-soho/RESEARCH.md`

## Carbohydrate Estimation Protocol

**Updated:** 2025-11-02  
**Scope:** Applies to every dish, ingredient, and log entry in this skill.

---

### 1. Terminology & Required Fields

Every `per_portion` block must track carbohydrate data with three explicit fields:

| Field | Meaning | Default precision |
| --- | --- | --- |
| `carbs_total_g` | Label-style total carbohydrate (includes fibre + polyols) | 0.1 g |
| `carbs_available_g` | Digestible / "available" carbohydrate (a.k.a. net carbs) | 0.1 g |
| `polyols_g` | Sugar alcohol mass; 0.0 if none or unknown | 0.1 g |

- `fiber_total_g` continues to represent total dietary fibre (soluble + insoluble).
- Relationship check: `carbs_total_g = carbs_available_g + fiber_total_g + polyols_g` (within rounding).

**Zero vs null conventions:**
- Use `0.0` for confirmed zero values (e.g., zero-carb foods like plain chicken have `carbs_total_g: 0.0`).
- Use `null` for unknown or unmeasured values.
- For zero-carb animal protein sources (meat, poultry, fish), set all carb and fiber fields to `0.0` (scientifically accurate).
- For processed foods without fiber data, use `null` unless you can confirm zero fiber from ingredients.

---

### 2. Source Classification

1. **UK / EU labels & venue data (Deliveroo, Tesco, SHK, etc.)**
   - Labels already report *available* carbohydrate.
   - Record the printed value in `carbs_available_g`.
   - Derive `carbs_total_g = carbs_available_g + fiber_total_g + polyols_g`.

2. **US / Canada sources (USDA FDC, MyFitnessPal US, Nutritionix, etc.)**
   - Labels list *total* carbohydrate.
   - Copy the label into `carbs_total_g`.
   - Subtract fibre and any polyols to obtain `carbs_available_g`.
   - Flag the change in the dish `change_log` with source notes.

3. **Ambiguous / mixed sources**
   - Check the change log and notes—if “net carbs” or “available carbs” is mentioned, treat as UK/EU style.
   - Otherwise default to US handling and document assumptions.

---

### 3. Polyol Treatment

- When a label lists specific sugar alcohols, record them in `polyols_g`.
- If multiple polyols are present and their masses differ, add a note describing the breakdown.
- Energy factors (default unless more precise data are available):
  - Maltitol, sorbitol, xylitol: **2.4 kcal/g**
  - Erythritol: **0.2 kcal/g**
  - Other polyols: reference EU guideline tables; if unknown, fall back to 2.4 kcal/g and document.

---

### 4. Energy Recalculation Checklist

Use the UK/EU convention and store the result directly in `per_portion.energy_kcal`:

```
energy_kcal =
    4 * protein_g
  + 9 * fat_g
  + 4 * carbs_available_g
  + 2 * fiber_total_g
  + polyol_factor * polyols_g
```

- `polyol_factor` is 2.4 kcal/g unless evidence specifies another value.
- Always recompute `per_portion.energy_kcal` after updating carbs.

**Energy storage policy:**
- **Store the calculated energy** (from the formula above) in `per_portion.energy_kcal`.
- If the calculated value differs from the venue/label energy, **note the original label value** in the `notes` field.
- Document the variance in the `change_log` when updating energy values.
- If the gap exceeds ±8%:
  1. Confirm source classification (UK/EU vs US/Canada).
  2. Double-check macronutrient values for accuracy.
  3. If values are correct, proceed with calculated energy and document the variance.

---

### 5. Change Log Requirements

Whenever carbohydrate fields change:

1. Bump `version` (if editing a dish) and update `last_verified`.
2. Add a `change_log` entry with:
   - ISO timestamp (Europe/London)
   - `updated_by`
   - `reason` (e.g., “Converted USDA total carbs to UK available convention”)
   - `fields_changed` covering the carb fields and energy
   - `sources` referencing the label, USDA record, or calculation note

---

### 6. Daily Log Alignment

- Logs should mirror the dish data: include `carbs_total_g`, `carbs_available_g`, and `polyols_g` for each entry.
- When scaling a dish (e.g., half-portion), scale all carbohydrate fields proportionally.
- Custom log-only items follow the same rules as dishes—classify the source first, then populate the three fields and recompute energy.

---

### 7. Validation Script Expectations

The validator (`scripts/validate_data_bank.py`) assumes:

- `carbs_available_g` is present when `carbs_total_g` is present.
- `carbs_total_g ≈ carbs_available_g + fiber_total_g + polyols_g`.
- `per_portion.energy_kcal` matches the available-carb formula above (±8% tolerance).

Any violations emit warnings to catch regressions before committing.
