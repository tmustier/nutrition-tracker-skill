# Complete workflow for adding dishes

**CRITICAL: Follow this complete workflow when adding new dishes. Do NOT skip steps.**

1. **Research thoroughly** (use multiple sources):
   - Start with delivery platforms (Deliveroo/Uber Eats) for calorie counts and ingredient lists
   - Search for venue PDFs, allergen menus, nutrition guides
   - Look at photos (venue website, Google Maps, social media) to estimate portions
   - Check reviews for portion size hints ("massive", "small", etc.)
   - Search for chef recipes, prep videos, or ingredient breakdowns
   - **Be creative**: if standard sources fail, use comparable dishes, USDA data, or ingredient analysis
   - **Goal**: Fill in ALL nutrition fields, not just calories and macros

2. **Create dish file and populate data**:
   - Use `scripts/new_dish_from_template.py` to create a new dish file in the appropriate folder:
     ```bash
     python scripts/new_dish_from_template.py \
       --dish_slug dish_name \
       --venue_slug venue_abbreviation \
       --venue_name "Full Venue Name" \
       --display_name "Dish Name (Venue)" \
       --category main
     ```
   - The script auto-detects the venue category and creates the file in the correct location
   - Fill in ALL available fields: macros, micronutrients, MUFA/PUFA breakdown
   - For estimated values, document your reasoning in `assumptions` and `notes`
   - Add comprehensive `source.evidence` with URLs and methods used
   - Update `change_log` with timestamp and what you added

3. **Validate before committing**:
   - Run `python scripts/validate_data_bank.py` (no arguments needed - scans all files)
   - Fix any errors (energy math, fat splits, sodium/salt)
   - Re-run validation until ALL items pass
   - The index (`data/food-data-bank-index.md`) will be auto-generated by the validation script

4. **Document research findings** (if applicable):
   - Add **venue-specific** learnings to the venue's `RESEARCH.md` file
   - Location: `data/food-data-bank/venues/{venue-name}/RESEARCH.md`
   - **ONLY include venue-specific information:**
     - Data sources for this venue (PDFs, Deliveroo quirks, menu websites)
     - Menu characteristics (signature ingredients, portion sizes, cooking styles)
     - Case studies of challenging dishes from this venue
   - **DO NOT include general methodology** (standard portions, validation formulas, fatty acid profiles) - those belong in this document

5. **Commit with clear message**:
   - Commit changes with descriptive message
   - Include calorie counts and what was added in the commit message

**Do NOT default to generic values. If exact data is unavailable, use ingredient-based estimation and document your method.**

---

# CLI Scripts

**`validate_data_bank.py`**: Validates all dish files (energy math, fat splits, sodium/salt). Usage: `python scripts/validate_data_bank.py`

**`new_dish_from_template.py`**: Creates dish file in appropriate venue folder. Usage: `python scripts/new_dish_from_template.py --dish_slug NAME --venue_slug ABBR --venue_name "Full Name" --display_name "Dish (Venue)" --category CATEGORY`

**`generate_index.py`**: Regenerates food bank index (auto-called by validator). Usage: `python scripts/generate_index.py`

---

# Quick Reference Data

## Standard Portions

| Item | Weight | Notes |
|------|--------|-------|
| Eggs | 50g each | Standard large egg |
| Bread slice | 60g | 50-70g range; NOT 100g |
| Yogurt | 100-120g | Restaurant serving |
| Cooked vegetables | 50-80g | Side portion |
| Restaurant soup | ~300g | Standard bowl |

## Fatty Acid Profiles

**Common Oils:**
- **Olive oil:** ~73% MUFA, ~11% PUFA, ~14% SFA
- **Coconut:** ~83% SFA, ~6% MUFA, ~2% PUFA
- **Butter:** ~51% SFA, ~21% MUFA, ~3% PUFA

**Common Proteins:**
- **Wagyu beef:** ~40% MUFA, ~20% PUFA of total fat
- **Chicken:** ~45% MUFA, ~21% PUFA of total fat
- **Salmon:** ~29% MUFA, ~40% PUFA of total fat

## Research Source Priority

1. **PRIMARY (highest confidence):** Deliveroo UK, Uber Eats UK, venue nutrition PDFs, product labels
2. **SECONDARY (estimate/scale):** USDA FoodData Central, MyFoodData.com, comparable dishes from similar venues

## Validation Formulas

- **Energy (Atwater):** `4×protein + 9×fat + 4×carbs_available + 2×fiber + 2.4×polyols` (tolerance ±5-8%)
- **Fat split:** `sat + MUFA + PUFA + trans ≤ total_fat`
- **Sodium/salt:** `salt_g = sodium_mg × 2.5 / 1000`
- **Finishing salt:** `0.5% of total dish weight` (≈ sodium_mg = salt_g × 400)

---

# Nutrient Estimation Philosophy

## Core Principle

**Never use null. Always estimate with documented confidence.**

- `0` = TRUE ZERO (scientifically impossible, e.g., cholesterol in plants, fiber in animal products, B12 in unfortified plants)
- All other values = actual measurement or estimate (use USDA proxies, component analysis, or category averages if needed)
- Document estimation method and confidence level in `assumptions`

## Estimation Process

1. **Search USDA FoodData Central** for closest match
2. **Scale to portion weight** (USDA values are per 100g)
3. **Document source and confidence** in `assumptions` field if non-obvious
4. **Validate energy**: 4P + 9F + 4C_avail + 2fiber + 2.4polyols

## Confidence Levels

- **HIGH** (±5-15%): USDA direct match, nutrition label
- **MEDIUM** (±20-40%): USDA proxy, component calculation, UK dairy iodine
- **LOW** (±50-100%): category average, soil-dependent nutrients

## UK-Specific Note

**Iodine in dairy**: UK cattle feed is fortified, resulting in 2-3× higher iodine than EU. UK dairy is MEDIUM-HIGH confidence for iodine estimates.

## TRUE ZEROS

No estimation needed when value is scientifically zero:
- Cholesterol: plant foods
- B12: unfortified plant foods
- Fiber: pure animal products
- Iodine: pure oils/fats

# Analysis rules
Always write down what was used. Put links/notes under `source.evidence`.

**For Simple Health Kitchen (SHK):**
- **Check both**: the **Deliveroo** page (names, **ingredient list**, photos) **and** the **SHK Calories PDF**
  (kcal and P/C/F). Names may differ slightly; match the prep, not just the label.
- **Anchor macros** (kcal, protein, carbs, fat) to the SHK source that exactly matches the dish:
  - If the PDF has the **exact same item**, prefer it for macros.
  - If the PDF lists a **different prep** (e.g., *Roasted Sweet Potatoes* vs *Wedges*), prefer Deliveroo macros
    for the dish actually ordered.
- **Use Deliveroo ingredients + photos** to infer: oil type, dressing, toppings, and portion reasonableness.
- **Compute the rest** (sodium, sugars, fibre, vitamins/minerals, MUFA/PUFA/trans) from ingredient profiles
  (e.g., USDA/MyFoodData) **scaled to the anchored macros**.

**For other venues (get creative, but be explicit):**
- Use delivery menus (Deliveroo/Uber Eats/Just Eat), venue PDFs, and **photos** (gallery, socials, Google Maps).
- Read **ingredient lists** and **allergens**; check **reviews** for portion hints (“huge bowl”, “tiny cup”).
- Look for **chef/restaurant recipes** or prep videos that reveal oil type, cooking method, or weights.
- Estimate **portion weight** from photos: plate diameter, container size, standard yields (e.g., pasta ~140–160 g per cup cooked; salmon cooks down ~25% from raw). State the method in `assumptions`.
- If nothing authoritative exists, choose the **closest canonical ingredient profile** and **record the choice**.

**Component-based estimation (REQUIRED for multi-ingredient dishes):**

When a dish has multiple identifiable components, use this method:

1. **List components and estimate known weights** using standard portions (see Quick Reference). Leave one component (usually fat/oil) as the "closing variable"

2. **Calculate sub-totals** for known components using USDA/MyFoodData, then solve for the unknown component to close the calorie gap
   - Example: Known components = 379 kcal, venue lists 592 kcal → 213 kcal gap → butter is ~7.2 kcal/g → ~30g butter

3. **Sum complete macros** from USDA profiles scaled to estimated weights. Add finishing salt (default assumption: 0.5% of total dish weight) to sodium

4. **Validate** energy within ±5-8% using Atwater formula (see Quick Reference). Document method in `notes`

**Example:** Chilli Poached Eggs (L'ETO, 592 kcal): 2 eggs (100g, 140 kcal) + yogurt (120g, 72 kcal) + sourdough (60g, 150 kcal) + kale (50g, 17 kcal) = 379 kcal. Butter: 213 kcal gap → ~30g. Total weight 352g → finishing salt 1.76g = 704mg sodium. Validates to 597 kcal (±1%).

---

# Carbohydrate Estimation Protocol

**Updated:** 2025-11-02 | **Scope:** All dishes, ingredients, and log entries

## Required Fields

Every `per_portion` block must include three carbohydrate fields:

| Field | Meaning | Precision |
| --- | --- | --- |
| `carbs_total_g` | Total carbohydrate (includes fiber + polyols) | 0.1 g |
| `carbs_available_g` | Digestible / "net" carbohydrate | 0.1 g |
| `polyols_g` | Sugar alcohols (0.0 if none) | 0.1 g |

**Relationship:** `carbs_total = carbs_available + fiber + polyols` (within rounding)

**TRUE ZEROS:** For zero-carb animal proteins (meat, poultry, fish), use `0.0` for all carb and fiber fields.

## Source Handling

**UK/EU labels** (Deliveroo, Tesco, SHK): Report *available* carbs → record directly in `carbs_available_g`, then derive `carbs_total_g = carbs_available_g + fiber_total_g + polyols_g`

**US/Canada sources** (USDA, Nutritionix): Report *total* carbs → record in `carbs_total_g`, then subtract fiber and polyols to get `carbs_available_g`

**Ambiguous sources:** Check change log for "net carbs" or "available carbs" mentions. If unclear, treat as US handling and document.

## Polyol Energy Factors

- Maltitol, sorbitol, xylitol: **2.4 kcal/g**
- Erythritol: **0.2 kcal/g**
- Other polyols: Use EU guidelines or default to 2.4 kcal/g

## Energy Calculation

Always use: `energy_kcal = 4×protein + 9×fat + 4×carbs_available + 2×fiber + 2.4×polyols`

**Storage policy:** Store calculated energy in `per_portion.energy_kcal`. If venue/label differs by >±8%, note original value in `notes` field and document variance in `change_log`. Confirm source classification (UK vs US) and recheck macros before accepting variance.
