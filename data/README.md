# Food Data Bank Index

The `food-data-bank-index.md` file is **auto-generated by CI** and not tracked in Git feature branches.

## Quick Reference

- **Main branch**: Always has the up-to-date index (regenerated by CI after every merge)
- **Feature branches**: Index is gitignored (not tracked)
- **To view locally**: Run `python scripts/generate_index.py`
- **View on GitHub**: [Main branch index](https://github.com/tmustier/nutrition-tracking/blob/main/data/food-data-bank-index.md)

---

## Why This Approach?

### The Problem
When multiple developers add dishes in parallel branches:
- Each branch regenerates the index with different content
- Merging causes conflicts on dish counts, timestamps, and dish lists
- These conflicts are tedious to resolve manually
- They block automerge functionality

### The Solution
The index file is **gitignored** and only exists on the main branch:
- ✅ **Zero merge conflicts** (file doesn't exist in feature branches)
- ✅ **Automerge compatible** (nothing to conflict on)
- ✅ **Always accurate on main** (CI regenerates after each merge)
- ✅ **Low friction** (developers can regenerate locally anytime)

---

## For Developers

### Viewing the Index

**Option 1: Regenerate locally (recommended)**
```bash
python scripts/generate_index.py
```
This creates a local copy with all current dishes (not committed).

**Option 2: View main branch version**
```bash
git show origin/main:data/food-data-bank-index.md
```
Shows the last committed version from main.

**Option 3: View on GitHub**
Browse to: `data/food-data-bank-index.md` on the main branch

### Adding New Dishes

1. Create your dish file in `data/food-data-bank/`
2. Optionally regenerate index locally to preview:
   ```bash
   python scripts/generate_index.py
   ```
3. Commit and push your dish file (NOT the index)
4. Create PR and merge
5. CI automatically regenerates the index on main

### Optional: Install Pre-commit Hook

For automatic local regeneration when you commit dish files:

```bash
bash scripts/install-hooks.sh
```

This installs a hook that:
- Regenerates the index when you commit dish files
- Shows you a local preview (index is still NOT committed)
- Prevents accidental commits of the gitignored index file

---

## For CI/CD

### How It Works

The `.github/workflows/regenerate-index.yml` workflow:
1. Triggers on pushes to `main` that modify `data/food-data-bank/`
2. Runs `python scripts/generate_index.py`
3. Force-commits the index (bypassing .gitignore) with `[ci skip]`
4. The index now reflects all dishes on main

### Index Metadata

The generated index includes rich metadata:

```yaml
---
title: Food Data Bank Index
description: Auto-generated index of all dishes in the food data bank
generated:
  timestamp: "2025-11-06 10:21:49 UTC"
  dishes_count: 76
  commit: "a131017"
  branch: "main"
  by: "CI"
---
```

This shows:
- **timestamp**: When the index was last generated
- **dishes_count**: Total dishes found (quick validation)
- **commit**: Git commit hash at generation time
- **branch**: Which branch generated it (should be "main")
- **by**: "CI" (generated by GitHub Actions) or "local" (manual)

---

## Troubleshooting

### Index missing locally?

**Solution**: Regenerate it
```bash
python scripts/generate_index.py
```

### Index outdated on feature branch?

**Expected behavior**. The index is only accurate on the main branch.

To preview with your new dishes:
```bash
python scripts/generate_index.py
```

### Need to search for a dish?

**Option 1**: Regenerate index locally and search it

**Option 2**: Search files directly
```bash
# Find all dishes
find data/food-data-bank -name "*.md" -type f | grep -v README

# Search for specific dish
grep -r "Salmon" data/food-data-bank
```

**Option 3**: Use the main branch index on GitHub

### Accidentally committed the index?

**Fix it**:
```bash
git rm --cached data/food-data-bank-index.md
git commit -m "Remove index file (managed by CI)"
git push
```

The PR validation workflow will catch this and fail the PR with helpful instructions.

---

## Edge Cases

### What if CI fails?

- The index won't be regenerated
- Main branch will have a stale index
- Next successful merge will regenerate it

**Manual fix**:
```bash
git checkout main
git pull
python scripts/generate_index.py
git add -f data/food-data-bank-index.md
git commit -m "chore: Manually regenerate index [ci skip]"
git push
```

### What if someone force-commits the index on a feature branch?

- The PR validation workflow will fail
- Clear error message explains how to fix it
- After fixing, automerge works normally

---

## Technical Details

### Git Behavior

- **Gitignored files** are not tracked by Git
- `.gitignore` prevents `git add` from staging them
- `git add -f` can bypass .gitignore (used by CI)
- File exists locally but not in commits (except main)

### Why Force-Add in CI?

The CI workflow uses `git add -f` to commit the index to main:
- Feature branches: index is gitignored (not tracked)
- Main branch: CI force-adds it after merges
- Result: Only one branch ever commits the file → no conflicts

### File Lifecycle

```
┌─────────────────┐
│ Feature Branch  │  Index gitignored (not in git)
└────────┬────────┘
         │ Merge PR
         ↓
┌─────────────────┐
│  Main Branch    │  PR merged, dish files updated
└────────┬────────┘
         │ Trigger CI
         ↓
┌─────────────────┐
│ CI Regenerates  │  python scripts/generate_index.py
└────────┬────────┘
         │ git add -f
         ↓
┌─────────────────┐
│  Main Branch    │  Index committed (with [ci skip])
└─────────────────┘
```

---

## Related Files

- **Index generator**: `scripts/generate_index.py`
- **CI workflow**: `.github/workflows/regenerate-index.yml`
- **PR validation**: `.github/workflows/validate.yml` (check-no-index-commit job)
- **Pre-commit hook**: `scripts/hooks/pre-commit`
- **Hook installer**: `scripts/install-hooks.sh`
- **Gitignore**: `.gitignore` (index exclusion rule)

---

## Summary

**TL;DR**: The index is managed by CI to prevent merge conflicts. Regenerate locally to preview, but don't commit it. Everything "just works" after merging to main.

For questions or issues, see the main project README or open an issue.
